# Hey Emacs, this is a -*- makefile -*-
#
# libFIRM Project
#
# Top level Makefile
# $Id$
#


# top directory of the source tree
top_srcdir := @top_srcdir@
# directory with the sources for this directory
srcdir := @srcdir@
# top directory of the configured tree
topdir := .
# subdirectory under topdir
subdir := .

subdirs := ir ir/adt ir/debug ir/tv ir/common ir/ident ir/ir ir/tr ir/ana ir/st

SOURCES := Makefile.in MakeRules.in MakeTargets\
	   aclocal.m4 config.h.in\
	   config.guess config.sub configure.in \
	   stamp-h.in install-sh README configure

INSTALL_LIBS = libfirm.a

GENFILES := stamp-h config.log config.cache
# config.status config.h.in $(srcdir)/stamp-h.in

include $(topdir)/MakeRules

XOFILES += $(addsuffix /subdir.o, $(subdirs))

include $(top_srcdir)/MakeTargets


all: config.h Makefile libfirm.a

libfirm.a: subdir_all $(XOFILES) $(OFILES)
	$(AR) $(ARFLAGS) $@.new $(XOFILES) $(OFILES)
	$(RANLIB) $@.new
	mv -f $@.new $@

testprograms:	libfirm.a
	$(MAKE) -C testprograms


# generate program documentation
.PHONY: autodoc
autodoc: autodoc_xref $(AUTODOCDIR) $(GLOBALXREFFILE) autodoc_html $(INDEXFILE)

$(GLOBALXREFFILE): $(addsuffix /$(LOCALXREFSFILE), $(subdirs)) .xrefs
#	cat $^ > $@
	$(RM) $@
	find $(PWD) -name "*.xref" -print > $@

$(INDEXFILE): $(GLOBALXREFFILE)
	$(AUTODOC) $(GLOBALXREFFILE) $@ INDEX HTML


#${srcdir}/configure: configure.in aclocal.m4
$(srcdir)/configure: configure.in
	cd $(srcdir) && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
$(srcdir)/config.h.in: stamp-h.in

#${srcdir2/stamp-h.in: configure.in aclocal.m4 acconfig.h \
$(srcdir)/stamp-h.in: configure.in
	cd $(srcdir) && autoheader
	echo timestamp > $(srcdir)/stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status

config.status: configure
	./config.status --recheck
